####    Makefile-macOS
###
###
#
#	cd <xxxxx>/librtlsdr_tcp
# rm -rf build
# mkdir build
# cd build
# make -f ../Makefile-macOS



LIBUSBINCLUDEDIR    = ../../libusb-1.0.26/libusb
LIBUSBSTATICDIRx86  = ../../libusb-1.0.26/build-static-x86_64-macos12
LIBUSBSTATICDIRARM  = ../../libusb-1.0.26/build-static-arm64-macos12

SRCDIR = ../src

SOURCE    =   $(SRCDIR)/rtl_tcp.c \
              $(SRCDIR)/librtlsdr.c \
							$(SRCDIR)/tuner_r82xx.c \
							$(SRCDIR)/tuner_e4k.c \
							$(SRCDIR)/tuner_fc0012.c \
							$(SRCDIR)/tuner_fc0013.c \
							$(SRCDIR)/tuner_fc2580.c \
							$(SRCDIR)/convenience/convenience.c

LIBx86 =      $(LIBUSBSTATICDIRx86)/libusb-1.0.a \
							$(LIBUSBSTATICDIRx86)/darwin_usb.o


LIBARM =      $(LIBUSBSTATICDIRARM)/libusb-1.0.a \
							$(LIBUSBSTATICDIRARM)/darwin_usb.o


EXECUTABLE = 	rtl_tcp
FOLDER = 			rtl_tcp-v2.0.1-macos12
DMG	=					rtl_tcp-v2.0.1-macos12.dmg

rtl_tcp:			$(SRCDIR)/rtl_tcp.c

								clang $(SOURCE)  $(LIBx86) \
								    -framework Foundation  \
							      -framework IOKit  \
										-framework Security \
										-I. \
										-I$(SRCDIR)/../include \
										-L/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
							      -target x86_64-apple-macos12 -lm -o rtl_tcp-x86_64

								clang $(SOURCE)  $(LIBARM) \
										 -framework Foundation  \
										 -framework IOKit  \
										 -framework Security \
										 -I. \
										 -I$(SRCDIR)/../include \
										 -L/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
										 -target arm64-apple-macos12 -lm -o rtl_tcp-arm64

								lipo -create -output rtl_tcp rtl_tcp-x86_64 rtl_tcp-arm64
                lipo -archs rtl_tcp
								otool -L rtl_tcp


dmg:						rtl_tcp

                 mkdir $(FOLDER)
                 # Place Universal Binary Executable in Folder
                 cp $(EXECUTABLE) $(FOLDER)
                 # Codesign Executable
                 codesign -vf --timestamp --options runtime --sign "Developer ID Application: Transition Technology Ventures, LLC (6V82P5ET42)" $(FOLDER)/$(EXECUTABLE)
                 # Create .dmg from the Folder
                 hdiutil create -fs HFS+ -srcfolder $(FOLDER) -volname $(FOLDER) $(FOLDER).dmg
                 # Codesign .dmg
                 codesign -vf --timestamp --options runtime --sign "Developer ID Application: Transition Technology Ventures, LLC (6V82P5ET42)" $(DMG)
                 codesign --verify --verbose $(DMG)
                 # Notarize .dmg
                 xcrun notarytool submit $(DMG) --keychain-profile "SDR" --wait
                 spctl -a -t open --context context:primary-signature -v $(DMG)
                 # Staple Ticket to .dmg and Validate
                 xcrun stapler staple  xcrun stapler $(DMG)
                 xcrun stapler validate $(DMG)
